---
name: Get latest Rancher tag
description: Gets the latest Rancher tag for the specified release lines
inputs:
  release_lines:
    description: "List Rancher release lines"
    required: true
  prime_artifacts_path:
    description: "Path to prime artifacts"
    required: true
outputs:
  latest_tag_v214:
    description: "Latest tag for v2.14"
    value: ${{ steps.set-outputs.outputs.latest_tag_v214 }}
  latest_tag_v213:
    description: "Latest tag for v2.13"
    value: ${{ steps.set-outputs.outputs.latest_tag_v213 }}
  latest_tag_v212:
    description: "Latest tag for v2.12"
    value: ${{ steps.set-outputs.outputs.latest_tag_v212 }}
runs:
  using: composite
  steps:
    - id: get-tags
      run: |
        RELEASE_LINES="${{ inputs.release_lines }}"
        TAGS=$(curl -s https://api.github.com/repos/rancher/rancher/releases | jq -r '.[].tag_name')

        for RELEASE_LINE in $RELEASE_LINES; do
          LATEST_VERSION=$(curl -s https://api.github.com/repos/rancher/rancher/releases | jq -r '.[].tag_name' | grep -E "^$RELEASE_LINE" | head -n 1 || true)

          SUFFIX=$(echo "$RELEASE_LINE" | tr -d '.')

          if [[ -z "$LATEST_VERSION" ]]; then
            echo "No tag found for $RELEASE_LINE, skipping..."
            eval "LATEST_TAG_${SUFFIX}=''"
            echo "LATEST_TAG_${SUFFIX}=" >> $GITHUB_ENV
            continue
          fi

          echo "Latest tag for $RELEASE_LINE: $LATEST_VERSION"

          if [[ "$RELEASE_LINE" == "v2.14" || "$RELEASE_LINE" == "v2.13" ]]; then
            RELEASE_JSON=$(curl -s "https://api.github.com/repos/rancher/rancher/releases/tags/$LATEST_VERSION")
            ASSET_COUNT=$(echo "$RELEASE_JSON" | jq '.assets | length')

            echo "Asset count for $LATEST_VERSION: $ASSET_COUNT"

            if [ "$ASSET_COUNT" -lt 17 ]; then
              echo "Asset count: $ASSET_COUNT. Expected at least 17 assets..."
              LATEST_VERSION=""
            fi
          else
            RELEASE_JSON=$(curl -s ${{ inputs.prime_artifacts_path }}/$RELEASE_LINE/rancher-images.txt)

            if [[ $? -ne 0 ]]; then
              echo "Unable to reach: ${{ inputs.prime_artifacts_path }}/$RELEASE_LINE/rancher-images.txt"
              LATEST_VERSION=""
            fi
          fi

          eval "LATEST_TAG_${SUFFIX}=$LATEST_VERSION"
          echo "LATEST_TAG_${SUFFIX}=$LATEST_VERSION" >> $GITHUB_ENV
        done
      shell: bash
    - id: set-outputs
      run: |
        echo "latest_tag_v214=${LATEST_TAG_v214}" >> $GITHUB_OUTPUT
        echo "latest_tag_v213=${LATEST_TAG_v213}" >> $GITHUB_OUTPUT
        echo "latest_tag_v212=${LATEST_TAG_v212}" >> $GITHUB_OUTPUT
      shell: bash